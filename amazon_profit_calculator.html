<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äºšé©¬é€Šäº§å“åˆ©æ¶¦è®¡ç®—å™¨ - AMZAIListing</title>
    <style>
        :root {
            --primary-color: #007bff;
            --bg-light: #f8f9fa;
            --bg-white: #ffffff;
            --text-main: #343a40;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
        }
        
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-light);
            color: var(--text-main);
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        
        header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: bold;
            letter-spacing: 1px;
            padding: 0;
        }
        
        #user-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        #user-actions .nav-btn {
            margin: 0;
            box-shadow: none;
            background: transparent;
            border: 1px solid white;
            color: white;
        }
        
        #user-actions .nav-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: white;
            color: white;
        }
        
        .nav-bar {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-top: 12px;
            position: relative;
            z-index: 2;
        }
        
        .nav-btn {
            background: #fff;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            border-radius: 999px;
            font-size: 18px;
            font-weight: 500;
            padding: 8px 32px;
            margin: 0 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }
        
        .nav-btn.active, .nav-btn:active {
            background: var(--primary-color);
            color: #fff;
            box-shadow: 0 4px 16px rgba(0,122,255,0.10);
            border-color: var(--primary-color);
        }
        
        .nav-btn:hover:not(.active) {
            box-shadow: 0 6px 20px rgba(0,122,255,0.13);
            border-color: var(--primary-color);
            color: var(--primary-color);
            background: rgba(0,122,255,0.1);
        }
        
        main {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: flex-start;
            gap: 32px;
            padding: 32px 8px 24px 8px;
            min-height: 60vh;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .form-container {
            flex: 2;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-white);
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            padding: 32px 24px;
            min-width: 320px;
            max-width: 800px;
        }
        
        .results-container {
            flex: 1;
            position: sticky;
            top: 20px;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-white);
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            padding: 32px 24px;
            min-width: 320px;
            max-width: 400px;
        }
        
        h2 {
            color: var(--primary-color);
            margin-bottom: 16px;
            font-size: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }
        
        .grid-container {
            display: grid;
            gap: 25px;
        }
        
        #presets-section .grid-container {
            grid-template-columns: repeat(3, 1fr);
        }
        
        #product-attributes-section .grid-container,
        #product-costs-section .grid-container {
            grid-template-columns: repeat(4, 1fr);
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }
        
        .input-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }
        
        .input-group .input-wrapper {
            display: flex;
            align-items: stretch;
        }
        
        label {
            font-weight: 600;
            margin-bottom: 5px;
            display: block;
        }
        
        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            font-size: 16px;
            background-color: var(--bg-light);
            color: var(--text-main);
            box-sizing: border-box;
            min-height: 40px;
        }
        
        .input-group .input-wrapper > input {
            flex-grow: 1;
            border-radius: 12px 0 0 12px;
            border-right: none;
            min-width: 50px;
            margin-bottom: 0;
        }
        
        .input-group .input-wrapper > select, 
        .input-group .input-wrapper > .unit-label,
        .input-group .input-wrapper > .fetch-btn {
            border-radius: 0 12px 12px 0;
            margin-bottom: 0;
        }
        
        .input-group .input-wrapper > select, .input-group .input-wrapper > .unit-label {
            background-color: var(--bg-light);
            cursor: pointer;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-left: none;
            width: 90px; /* Fixed width for currency dropdowns */
            flex-shrink: 0; /* Prevent shrinking */
        }

        .textarea-wrapper {
            position: relative;
            display: flex;
            width: 100%;
        }

        .clear-textarea-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ccc;
            color: white;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 16px;
            line-height: 22px;
            text-align: center;
            cursor: pointer;
            display: none; /* Initially hidden */
            transition: background-color 0.2s;
        }

        .clear-textarea-btn:hover {
            background: #999;
        }
        
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            background-color: var(--bg-white);
        }
        
        .fetch-btn {
            padding: 12px 15px;
            border: 1px solid var(--primary-color);
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s;
            border-left: none;
        }
        
        .fetch-btn:hover {
            background-color: #005fcc;
        }
        
        .calculate-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            align-self: flex-start;
            margin-top: 24px;
            width: 100%;
        }
        
        .calculate-btn:hover {
            background-color: #005fcc;
        }
        
        .results {
            margin-top: 1rem;
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        .result-item {
            background-color: var(--bg-light);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .result-item h3 {
            margin: 0;
            color: var(--text-main);
            font-size: 15px;
            font-weight: 500;
            border: none;
            padding: 0;
        }
        
        .result-item .value {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary-color);
            word-wrap: break-word;
        }
        
        .result-item .value.negative { 
            color: #dc3545;
        }

        .full-width { grid-column: 1 / -1; }
        .span-2 { grid-column: span 2; }
        .span-3 { grid-column: span 3; }
        .span-4 { grid-column: span 4; }

        #fetch-status {
            font-size: 12px;
            color: #666;
            height: 1.5em;
            padding-top: 5px;
        }

        .extension-guide {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border: 1px solid #bbdefb;
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
            font-size: 14px;
            color: #1565c0;
        }

        .extension-guide h4 {
            margin: 0 0 15px 0;
            color: #1565c0;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .extension-guide .step {
            background: rgba(255,255,255,0.7);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            border-left: 4px solid var(--primary-color);
        }

        .extension-guide .step-number {
            background: var(--primary-color);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }

        .extension-guide .download-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin: 10px 10px 10px 0;
            transition: background-color 0.3s;
        }

        .extension-guide .download-btn:hover {
            background: #005fcc;
        }

        .extension-guide .secondary-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin: 10px 10px 10px 0;
            transition: background-color 0.3s;
        }

        .extension-guide .secondary-btn:hover {
            background: #218838;
        }

        .go-to-amazon-btn {
            background: var(--primary-color);
            color: white;
            border: 1px solid var(--primary-color);
            border-left: none;
            padding: 12px 20px;
            border-radius: 0 12px 12px 0;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 0;
            flex-shrink: 0;
        }

        .go-to-amazon-btn:hover {
            background: #005fcc;
        }

        .manual-help {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 12px;
            padding: 15px;
            margin-top: 10px;
            font-size: 12px;
            color: #856404;
        }

        .manual-help h4 {
            margin: 0 0 10px 0;
            color: #856404;
            font-size: 14px;
        }

        .manual-help ul {
            margin: 5px 0;
            padding-left: 20px;
        }

        .manual-help li {
            margin-bottom: 5px;
        }

        #history-section {
            margin-top: 40px;
        }
        
        #history-section h2 {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-actions {
            display: flex;
            gap: 10px;
        }
        
        #clear-history-btn, #export-csv-btn {
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 12px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        #clear-history-btn {
            background-color: #dc3545;
        }
        
        #export-csv-btn {
            background-color: #28a745;
        }
        
        #clear-history-btn:hover {
            background-color: #c82333;
        }
        
        #export-csv-btn:hover {
            background-color: #218838;
        }
        
        .history-table-container {
            overflow-x: auto;
        }
        
        #history-section table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        #history-section th, #history-section td {
            border: 1px solid #e0e0e0;
            padding: 12px 15px;
            text-align: left;
            font-size: 14px;
            vertical-align: middle;
        }
        
        #history-section th {
            background-color: #f9f9f9;
            font-weight: 600;
        }
        
        #history-section td a {
            color: #007bff;
            text-decoration: none;
            word-break: break-all;
        }
        
        #history-section td a:hover {
            text-decoration: underline;
        }
        
        #history-section .delete-row-btn {
            background: none;
            border: none;
            color: #e74c3c;
            cursor: pointer;
            font-size: 16px;
            padding: 5px;
        }
        
        .site-footer {
            background-color: #343a40;
            padding: 24px 16px;
            text-align: center;
            color: white;
            font-size: 14px;
            border-top: none;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            margin-top: 40px;
            border-radius: 12px 12px 0 0;
            width: 100%;
            position: static;
        }
        
        .site-footer a {
            color: #ffffff;
            text-decoration: underline;
            font-weight: 500;
            margin: 0 8px;
        }
        
        .site-footer a:hover {
            text-decoration: none;
            opacity: 0.9;
        }
        
        .donate-button {
            position: fixed;
            right: 20px;
            bottom: 20px;
            background-color: #fd7e14;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 999px;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 999;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: #fff;
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            max-width: 800px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
        }
        
        .close-button {
            position: absolute;
            top: 10px;
            right: 14px;
            font-size: 20px;
            cursor: pointer;
        }

        summary {
            cursor: pointer;
            list-style: none; /* Hide the default arrow */
        }

        summary::-webkit-details-marker {
            display: none; /* Hide the default arrow in Chrome */
        }

        summary h2 {
            display: inline-block;
            position: relative;
            padding-left: 20px;
        }

        summary h2::before {
            content: 'â–¶';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%) rotate(0deg);
            transition: transform 0.2s;
            font-size: 14px;
        }

        details[open] > summary h2::before {
            transform: translateY(-50%) rotate(90deg);
        }

        .required-star {
            color: #dc3545;
            margin-left: 2px;
        }

        .input-error {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.2);
        }

        /* Style for the wrapper when it contains an invalid input */
        .input-wrapper.input-error {
            box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.2);
            border-radius: 12px;
        }

        .input-wrapper.input-error > input,
        .input-wrapper.input-error > select {
            border-color: #dc3545 !important;
        }

        @media (max-width: 1200px) {
            #presets-section .grid-container,
            #product-attributes-section .grid-container,
            #product-costs-section .grid-container {
                grid-template-columns: repeat(2, 1fr);
            }
            .span-3 { grid-column: span 2; }
            .span-4 { grid-column: span 2; }
        }
        
        @media (max-width: 992px) {
            main {
                flex-direction: column;
                gap: 20px;
            }
            .results-container {
                position: static;
                width: 100%;
            }
            .nav-bar {
                flex-wrap: wrap;
                justify-content: center;
                gap: 10px;
            }
            .nav-btn {
                padding: 7px 16px;
                font-size: 15px;
            }
        }
        
        @media (max-width: 768px) {
            .form-container, .results-container { 
                padding: 20px; 
            }
            #presets-section .grid-container,
            #product-attributes-section .grid-container,
            #product-costs-section .grid-container {
                grid-template-columns: 1fr;
            }
            .span-2, .span-3, .span-4 { grid-column: span 1; }
            header h1 {
                font-size: 22px;
            }
            main {
                padding: 8px 2px 12px 2px;
            }
        }
        
        @media (max-width: 600px) {
            header h1 {
                font-size: 22px;
                padding: 18px 0 0 0;
            }
            .nav-btn {
                font-size: 15px;
                padding: 7px 16px;
            }
            .nav-bar {
                gap: 10px;
            }
            main {
                padding: 8px 2px 12px 2px;
            }
            .form-container, .results-container {
                padding: 12px 4px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>äºšé©¬é€Šäº§å“åˆ©æ¶¦è®¡ç®—å™¨</h1>
        <div id="user-actions">
            <a href="auth.html" class="nav-btn" id="auth-btn">ç™»å½•/æ³¨å†Œ</a>
        </div>
    </header>
    <nav class="nav-bar">
        <a href="index.html" class="nav-btn">Listingç”Ÿæˆå™¨</a>
        <a href="zhuangxiang.html" class="nav-btn">è£…ç®±è®¡ç®—å™¨</a>
        <a href="amazon_profit_calculator.html" class="nav-btn active">åˆ©æ¶¦è®¡ç®—å™¨</a>
        <a href="history.html" class="nav-btn">å†å²è®°å½•</a>
        <a href="extension-download.html" class="nav-btn">ä¸‹è½½æ‰©å±•</a>
    </nav>
    <main>
        <div class="form-container">
            <section id="presets-section">
                <details>
                    <summary><h2>åŸºç¡€è®¾ç½®</h2></summary>
                    <div class="grid-container" style="padding-top: 15px;">
                        <div class="input-group">
                            <label for="exchangeRate">ç¾å…ƒå¯¹äººæ°‘å¸æ±‡ç‡</label>
                            <input type="number" id="exchangeRate" value="7.25">
                        </div>
                        <div class="input-group">
                            <label for="headHaulRate">å¤´ç¨‹ç‰©æµå•ä»· (CNY/kg)</label>
                            <input type="number" id="headHaulRate" value="30">
                        </div>
                        <div class="input-group">
                            <label>FBAè®¡è´¹è§„åˆ™</label>
                            <div style="padding: 12px; border: 1px solid #eee; border-radius: 8px; background: #fafafa; font-size: 14px; height: 100%; box-sizing: border-box;">
                                åŸºäºç¾ç«™æ ‡å‡†å°ºå¯¸/å¤§ä»¶çš„ç®€åŒ–æ¨¡å‹è‡ªåŠ¨è®¡ç®—ã€‚
                            </div>
                        </div>
                    </div>
                </details>
            </section>

            <section id="product-attributes-section" style="margin-top: 20px;">
                <h2>äº§å“å±æ€§</h2>
                <div class="grid-container">
                    <div class="input-group span-4">
                        <label for="productInfoPaste">ç²˜è´´äº§å“ä¿¡æ¯</label>
                        <div class="textarea-wrapper">
                            <textarea id="productInfoPaste" rows="6" style="width: 100%; padding: 10px 40px 10px 10px; border-radius: 12px; border: 1px solid var(--border-color); font-size: 14px; background-color: var(--bg-light); color: var(--text-main); box-sizing: border-box; margin-bottom: 0;" placeholder="åœ¨æ­¤å¤„ç²˜è´´ä»äºšé©¬é€Šé¡µé¢å¤åˆ¶çš„äº§å“ä¿¡æ¯ï¼Œç³»ç»Ÿå°†å°è¯•è‡ªåŠ¨å¡«å……ä»¥ä¸‹å­—æ®µã€‚"></textarea>
                            <button id="clearPasteBtn" class="clear-textarea-btn" onclick="clearPasteArea()">&times;</button>
                        </div>
                    </div>
                    <div class="input-group span-4">
                        <label for="productName">äº§å“åç§°</label>
                        <input type="text" id="productName" placeholder="ä¾‹å¦‚: æ™ºèƒ½é¢ˆéƒ¨æŒ‰æ‘©ä»ª">
                    </div>
                    <div class="input-group span-4">
                        <label for="competitorLink">å‚è€ƒç«å“é“¾æ¥ (Chromeæ’ä»¶è‡ªåŠ¨è·å–)</label>
                        <div class="input-wrapper">
                            <input type="url" id="competitorLink" placeholder="ç²˜è´´äºšé©¬é€Šå•†å“é“¾æ¥">
                            <button class="go-to-amazon-btn" onclick="goToAmazonAndExtract()">è·³è½¬æå–</button>
                        </div>
                        <div id="fetch-status"></div>
                        
                        <div id="extension-guide" class="extension-guide" style="display: none;">
                            <h4>ğŸš€ ä½¿ç”¨Chromeæ’ä»¶è‡ªåŠ¨æå–äº§å“ä¿¡æ¯</h4>
                            
                            <div class="step">
                                <span class="step-number">1</span>
                                <strong>å®‰è£…Chromeæ’ä»¶ï¼š</strong>
                                <br>
                                <a href="#" class="download-btn" onclick="downloadExtension()">ğŸ“¥ ä¸‹è½½æ’ä»¶æ–‡ä»¶</a>
                                <a href="#" class="secondary-btn" onclick="showInstallGuide()">ğŸ“– æŸ¥çœ‹å®‰è£…æ•™ç¨‹</a>
                            </div>
                            
                            <div class="step">
                                <span class="step-number">2</span>
                                <strong>ä½¿ç”¨æ–¹æ³•ï¼š</strong>
                                <br>â€¢ ç²˜è´´Amazonå•†å“é“¾æ¥åˆ°ä¸Šæ–¹è¾“å…¥æ¡†
                                <br>â€¢ ç‚¹å‡»"è·³è½¬æå–"æŒ‰é’®è‡ªåŠ¨è·³è½¬åˆ°Amazoné¡µé¢
                                <br>â€¢ æ’ä»¶ä¼šè‡ªåŠ¨æå–äº§å“ä¿¡æ¯å¹¶è¿”å›åˆ°æœ¬é¡µé¢
                            </div>
                            
                            <div class="step">
                                <span class="step-number">3</span>
                                <strong>æ”¯æŒçš„ä¿¡æ¯ï¼š</strong>
                                <br>â€¢ äº§å“åç§°ã€é‡é‡ã€å°ºå¯¸ï¼ˆé•¿å®½é«˜ï¼‰
                                <br>â€¢ è‡ªåŠ¨å•ä½è½¬æ¢ï¼ˆè‹±åˆ¶â†’å…¬åˆ¶ï¼‰
                                <br>â€¢ æ™ºèƒ½è§£æå¤šç§Amazoné¡µé¢æ ¼å¼
                            </div>
                        </div>
                        
                        <div id="manual-help" class="manual-help" style="display: none;">
                            <h4>æ‰‹åŠ¨å¡«å†™æŒ‡å—ï¼š</h4>
                            <ul>
                                <li>åœ¨Amazonå•†å“é¡µé¢æ‰¾åˆ°"Product details"æˆ–"Technical Details"éƒ¨åˆ†</li>
                                <li>æŸ¥æ‰¾"Product Dimensions"æˆ–"Package Dimensions"è·å–å°ºå¯¸</li>
                                <li>æŸ¥æ‰¾"Item Weight"æˆ–"Shipping Weight"è·å–é‡é‡</li>
                                <li>å¦‚æœæ˜¯è‹±åˆ¶å•ä½ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è½¬æ¢ä¸ºå…¬åˆ¶</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label for="prodWeight">äº§å“é‡é‡ (kg)<span class="required-star">*</span></label>
                        <input type="number" id="prodWeight" placeholder="0.8">
                    </div>
                    <div class="input-group">
                        <label for="prodLength">é•¿ (cm)<span class="required-star">*</span></label>
                        <input type="number" id="prodLength" placeholder="æœ€é•¿è¾¹">
                    </div>
                    <div class="input-group">
                        <label for="prodWidth">å®½ (cm)<span class="required-star">*</span></label>
                        <input type="number" id="prodWidth" placeholder="ä¸­é—´è¾¹">
                    </div>
                    <div class="input-group">
                        <label for="prodHeight">é«˜ (cm)<span class="required-star">*</span></label>
                        <input type="number" id="prodHeight" placeholder="æœ€çŸ­è¾¹">
                    </div>

                    <div class="input-group span-4">
                        <label for="sellingPrice">äº§å“å”®ä»·<span class="required-star">*</span></label>
                        <div class="input-wrapper">
                            <input type="number" id="sellingPrice" placeholder="29.99">
                            <select id="sellingPriceCurrency"><option value="USD" selected>USD</option><option value="CNY">CNY</option></select>
                        </div>
                    </div>
                </div>
            </section>

            <section id="product-costs-section" style="margin-top: 20px;">
                <h2>äº§å“æˆæœ¬</h2>
                <div class="grid-container">
                    <div class="input-group span-2">
                        <label for="purchaseCost">äº§å“é‡‡è´­æˆæœ¬<span class="required-star">*</span></label>
                        <div class="input-wrapper">
                            <input type="number" id="purchaseCost" placeholder="35.00">
                            <select id="purchaseCostCurrency"><option value="USD">USD</option><option value="CNY" selected>CNY</option></select>
                        </div>
                    </div>
                    
                    <div class="input-group span-2">
                        <label for="referralFee">é”€å”®ä½£é‡‘ç‡ (%)<span class="required-star">*</span></label>
                        <input type="number" id="referralFee" value="15">
                    </div>
                    <div class="input-group span-2">
                        <label for="refundRate">é¢„ä¼°é€€æ¬¾åæŸç‡ (%)</label>
                        <input type="number" id="refundRate" value="0">
                    </div>

                     <div class="input-group span-2">
                        <label for="adCost">é¢„ä¼°å¹¿å‘Šæˆæœ¬ (å•ä»¶)</label>
                        <div class="input-wrapper">
                            <input type="number" id="adCost" value="0">
                            <select id="adCostCurrency"><option value="USD" selected>USD</option><option value="CNY">CNY</option></select>
                        </div>
                    </div>
                    <div class="input-group span-4">
                        <label for="storageFee">å…¶ä»–æˆæœ¬ (ä»“å‚¨/åŒ…è£…ç­‰)</label>
                        <div class="input-wrapper">
                            <input type="number" id="storageFee" value="0">
                            <select id="storageFeeCurrency"><option value="USD" selected>USD</option><option value="CNY">CNY</option></select>
                        </div>
                    </div>
                </div>
            </section>

            <button class="calculate-btn" onclick="calculateProfit()">è®¡ç®—åˆ©æ¶¦</button>

            <section id="history-section">
                <h2>
                    <span>è®¡ç®—å†å²</span>
                    <div class="history-actions">
                        <button id="export-csv-btn" onclick="exportToCSV()">å¯¼å‡ºä¸º CSV</button>
                        <button id="clear-history-btn" onclick="clearHistory()">æ¸…ç©ºå†å²</button>
                    </div>
                </h2>
                <div class="history-table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>äº§å“åç§°</th>
                                <th>ç«å“é“¾æ¥</th>
                                <th>å”®ä»· (USD)</th>
                                <th>é‡‡è´­æˆæœ¬ (USD)</th>
                                <th>å¤´ç¨‹ç‰©æµ (CNY)</th>
                                <th>FBAè´¹ç”¨ (CNY)</th>
                                <th>å‡€åˆ©æ¶¦ (CNY)</th>
                                <th>åˆ©æ¶¦ç‡</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="history-tbody">
                            <!-- History records will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </section>
        </div>

        <div class="results-container">
            <h2>è®¡ç®—ç»“æœ</h2>
            <div class="results">
                <div class="result-item">
                    <h3>å¤´ç¨‹ç‰©æµ (USD)</h3>
                    <span class="value" id="headHaulCostResult">-$--.--</span>
                </div>
                <div class="result-item">
                    <h3>FBAè´¹ç”¨ (USD)</h3>
                    <span class="value" id="fbaFeeResult">-$--.--</span>
                </div>
                <div class="result-item">
                    <h3>å‡€åˆ©æ¶¦ (USD)</h3>
                    <span class="value" id="netProfitUsd">-$--.--</span>
                </div>
                <div class="result-item">
                    <h3>å‡€åˆ©æ¶¦ (CNY)</h3>
                    <span class="value" id="netProfitCny">Â¥--.--</span>
                </div>
                <div class="result-item">
                    <h3>åˆ©æ¶¦ç‡</h3>
                    <span class="value" id="profitMargin">--.--%</span>
                </div>
                <div class="result-item">
                    <h3>æŠ•èµ„å›æŠ¥ç‡ (ROI)</h3>
                    <span class="value" id="roi">--.--%</span>
                </div>
            </div>
        </div>
    </main>
    
    <footer class="site-footer">
        <div class="footer-content">
            <p>Â© 2025 äºšé©¬é€Š Listing æé€Ÿç”Ÿæˆå™¨</p>
            <p>
                <a href="privacy-policy.html">éšç§æ”¿ç­–</a> |
                <a href="terms-of-service.html">æœåŠ¡æ¡æ¬¾</a> |
                <a href="about-us.html">å…³äºæˆ‘ä»¬</a> |
                <a href="mailto:gskanchan@163.com">è”ç³»æˆ‘ä»¬</a> |
                <a href="javascript:void(0);" onclick="openModal()">æäº¤åé¦ˆ</a>
            </p>
        </div>
    </footer>
    
    <div id="feedbackModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">Ã—</span>
            <iframe src="https://uqi0gjbiwfl.feishu.cn/share/base/form/shrcn0RZevoq7QLVvGN6U5gojqb"
                    frameborder="0" width="100%" height="700" style="border-radius: 12px;"></iframe>
        </div>
    </div>
    
    <div id="donateModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeDonate()">Ã—</span>
            <h3>â˜• è¯·æˆ‘å–æ¯å¥¶èŒ¶å§ï¼</h3>
            <img src="donate.png" alt="æ‰“èµäºŒç»´ç " style="max-width: 300px; width: 100%; border-radius: 10px;"/>
            <p style="margin-top: 10px;">é•¿æŒ‰æˆ–æ‰«ç æ”¯ä»˜ï¼Œæ„Ÿè°¢ä½ çš„æ”¯æŒï¼ğŸ¥°</p>
        </div>
    </div>
    
    <button onclick="openDonate()" class="donate-button">ğŸ’— è¯·æˆ‘å–å¥¶èŒ¶</button>

    <script>
        // --- FBA & Cost Calculation Logic ---
        // Updated FBA Rates for 2024 (US, Non-Apparel)
        const FBA_RATES_2024 = {
            small_standard: [
                { max_oz: 4, fee: 3.86 },
                { max_oz: 8, fee: 4.08 },
                { max_oz: 12, fee: 4.24 },
                { max_oz: 16, fee: 4.75 }
            ],
            large_standard: [
                { max_lb: 4/16, fee: 4.56 }, // 4 oz
                { max_lb: 8/16,  fee: 4.81 }, // 8 oz
                { max_lb: 12/16, fee: 5.15 }, // 12 oz
                { max_lb: 1,    fee: 5.80 }, // 16 oz
                { max_lb: 1.5,  fee: 6.37 },
                { max_lb: 2,    fee: 6.91 },
                { max_lb: 2.5,  fee: 7.17 },
                { max_lb: 3,    fee: 7.59 }
            ],
            large_standard_over_3_lb: { base_fee: 7.59, per_lb_over: 0.42, base_lb: 3 },
            oversize: { // Simplified to Small Oversize
                base_fee: 9.73,
                per_lb_over: 0.42,
                base_lb: 1
            }
        };
        
        function getValue(id) { return parseFloat(document.getElementById(id).value) || 0; }
        
        function getValueInUSD(id, exchangeRate) {
            const value = getValue(id);
            const currencySelect = document.getElementById(id + 'Currency');
            if (currencySelect && currencySelect.value === 'CNY') { return value / exchangeRate; }
            return value;
        }
        
        function calculateHeadHaulCost(weightKg, lengthCm, widthCm, heightCm, rateCnyPerKg, exchangeRate) {
            if (rateCnyPerKg <= 0) return 0;
            const actualWeight = weightKg > 0 ? weightKg : 0;
            let volumetricWeight = 0;
            if (lengthCm > 0 && widthCm > 0 && heightCm > 0) {
                volumetricWeight = (lengthCm * widthCm * heightCm) / 6000;
            }
            const chargeableWeight = Math.max(actualWeight, volumetricWeight);
            if (chargeableWeight <= 0) return 0;
            return (chargeableWeight * rateCnyPerKg) / exchangeRate;
        }

        function calculateFbaFee(weightKg, lengthCm, widthCm, heightCm) {
            if (weightKg <= 0 || lengthCm <= 0 || widthCm <= 0 || heightCm <= 0) {
                return 0;
            }

            const IN_PER_CM = 0.393701;
            const LB_PER_KG = 2.20462;

            const weightLb = weightKg * LB_PER_KG;
            
            const dimsIn = [lengthCm * IN_PER_CM, widthCm * IN_PER_CM, heightCm * IN_PER_CM].sort((a, b) => b - a);
            const [longest, median, shortest] = dimsIn;

            // 1. Determine Size Tier
            let tier = 'oversize';
            if (longest <= 15 && median <= 12 && shortest <= 0.75 && weightLb <= 1) {
                tier = 'small_standard';
            } else if (longest <= 18 && median <= 14 && shortest <= 8 && weightLb <= 20) {
                tier = 'large_standard';
            }

            // 2. Calculate Shipping Weight
            const dimensionalWeightLb = (longest * median * shortest) / 139;
            let shippingWeightLb = weightLb;
            if (tier === 'large_standard' && weightLb > 0.75) {
                shippingWeightLb = Math.max(weightLb, dimensionalWeightLb);
            } else if (tier === 'oversize') {
                shippingWeightLb = Math.max(weightLb, dimensionalWeightLb);
            }

            // 3. Calculate Fee based on Tier and Shipping Weight
            if (tier === 'small_standard') {
                const shippingWeightOz = shippingWeightLb * 16;
                for (const rate of FBA_RATES_2024.small_standard) {
                    if (shippingWeightOz <= rate.max_oz) return rate.fee;
                }
                return FBA_RATES_2024.small_standard[FBA_RATES_2024.small_standard.length - 1].fee;
            }

            if (tier === 'large_standard') {
                if (shippingWeightLb > 3 && shippingWeightLb <= 20) {
                    const rules = FBA_RATES_2024.large_standard_over_3_lb;
                    const additionalWeightInLb = Math.ceil(shippingWeightLb - rules.base_lb);
                    return rules.base_fee + additionalWeightInLb * rules.per_lb_over;
                }
                for (const rate of FBA_RATES_2024.large_standard) {
                    if (shippingWeightLb <= rate.max_lb) return rate.fee;
                }
                // Fallback for weights between last tier and 3lb
                return FBA_RATES_2024.large_standard[FBA_RATES_2024.large_standard.length - 1].fee;
            }

            if (tier === 'oversize') {
                // Using a simplified Small Oversize rule for items > 20 lb or large dimensions
                const rules = FBA_RATES_2024.oversize;
                const roundedWeight = Math.ceil(shippingWeightLb);
                const additionalWeight = roundedWeight > rules.base_lb ? roundedWeight - rules.base_lb : 0;
                return rules.base_fee + additionalWeight * rules.per_lb_over;
            }

            return 0; // Should not be reached
        }
        
        function clearPasteArea() {
            const pasteArea = document.getElementById('productInfoPaste');
            pasteArea.value = '';
            document.getElementById('clearPasteBtn').style.display = 'none';
            // Clear all related fields
            document.getElementById('productName').value = '';
            document.getElementById('competitorLink').value = '';
            document.getElementById('sellingPrice').value = '';
            document.getElementById('prodWeight').value = '';
            document.getElementById('prodLength').value = '';
            document.getElementById('prodWidth').value = '';
            document.getElementById('prodHeight').value = '';
        }

        function parseAndFillInfo() {
            const text = document.getElementById('productInfoPaste').value;

            const clearBtn = document.getElementById('clearPasteBtn');
            if (text.length > 0) {
                clearBtn.style.display = 'block';
            } else {
                clearBtn.style.display = 'none';
            }

            if (!text) return;

            // Using regex to find key-value pairs
            const extractValue = (key) => {
                const regex = new RegExp(`^${key}:\\s*(.*)$`, 'im');
                const match = text.match(regex);
                return match ? match[1].trim() : null;
            };

            const name = extractValue('äº§å“åç§°');
            const weightStr = extractValue('é‡é‡');
            const dimsStr = extractValue('å°ºå¯¸');
            const link = extractValue('é“¾æ¥');
            const priceStr = extractValue('ä»·æ ¼');
            const asin = extractValue('ASIN');

            if (name) {
                document.getElementById('productName').value = name;
            }

            if (link) {
                document.getElementById('competitorLink').value = link;
            } else if (asin) {
                document.getElementById('competitorLink').value = `https://www.amazon.com/dp/${asin}`;
            }

            if (priceStr) {
                const priceMatch = priceStr.match(/[\d.]+/);
                if (priceMatch) {
                    document.getElementById('sellingPrice').value = parseFloat(priceMatch[0]);
                }
            }

            if (weightStr) {
                const weightMatch = weightStr.match(/([\d.]+)\s*(Pounds|lbs?|kg|g)/i);
                if (weightMatch) {
                    let weight = parseFloat(weightMatch[1]);
                    const unit = weightMatch[2].toLowerCase();
                    let weightInKg = 0;

                    if (unit === 'pounds' || unit === 'lb' || unit === 'lbs') {
                        weightInKg = weight * 0.453592;
                    } else if (unit === 'kg') {
                        weightInKg = weight;
                    } else if (unit === 'g') {
                        weightInKg = weight / 1000;
                    }
                    
                    if (weightInKg > 0) {
                        document.getElementById('prodWeight').value = weightInKg.toFixed(3);
                    }
                }
            }

            if (dimsStr) {
                // Extracts all numbers from a string like '4.5"W x 9.2"H' -> ["4.5", "9.2"]
                const dimValues = dimsStr.match(/[\d.]+/g);
                if (dimValues) {
                    // Assume inches if '"' is present, otherwise it's ambiguous, but we'll proceed assuming inches as per example
                    const isImperial = dimsStr.includes('"');
                    
                    let dimsInCm = dimValues.map(v => parseFloat(v));
                    if (isImperial) {
                        dimsInCm = dimsInCm.map(d => d * 2.54);
                    }

                    // Sort descending to find longest, middle, shortest
                    dimsInCm.sort((a, b) => b - a);
                    
                    document.getElementById('prodLength').value = dimsInCm[0] ? dimsInCm[0].toFixed(2) : '';
                    document.getElementById('prodWidth').value = dimsInCm[1] ? dimsInCm[1].toFixed(2) : '';
                    document.getElementById('prodHeight').value = dimsInCm[2] ? dimsInCm[2].toFixed(2) : '';
                }
            }
        }
        
        function calculateProfit() {
            const requiredFieldIds = ['prodWeight', 'prodLength', 'prodWidth', 'prodHeight', 'sellingPrice', 'purchaseCost', 'referralFee'];
            let isValid = true;

            // First, clear all existing error states from inputs and their wrappers
            document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));

            requiredFieldIds.forEach(id => {
                const inputElement = document.getElementById(id);
                if (!inputElement.value.trim()) {
                    // Target the wrapper if it exists, otherwise the input itself
                    const wrapper = inputElement.closest('.input-wrapper');
                    const targetElement = wrapper || inputElement;
                    targetElement.classList.add('input-error');
                    isValid = false;
                }
            });

            if (!isValid) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¸¦çº¢è‰²æ˜Ÿå· (*) çš„å¿…å¡«é¡¹ã€‚');
                return;
            }

            const exchangeRate = getValue('exchangeRate');
            if (!exchangeRate || exchangeRate <= 0) { 
                alert('è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„æ­£æ•°æ±‡ç‡ï¼'); 
                document.getElementById('exchangeRate').classList.add('input-error');
                return; 
            } else {
                document.getElementById('exchangeRate').classList.remove('input-error');
            }
            
            const prodWeight = getValue('prodWeight');
            const prodLength = getValue('prodLength');
            const prodWidth = getValue('prodWidth');
            const prodHeight = getValue('prodHeight');
            const sellingPrice = getValueInUSD('sellingPrice', exchangeRate);
            const purchaseCost = getValueInUSD('purchaseCost', exchangeRate);
            const adCost = getValueInUSD('adCost', exchangeRate);
            const storageFee = getValueInUSD('storageFee', exchangeRate);
            const headHaulCost = calculateHeadHaulCost(prodWeight, prodLength, prodWidth, prodHeight, getValue('headHaulRate'), exchangeRate);
            const fbaFee = calculateFbaFee(prodWeight, prodLength, prodWidth, prodHeight);
            
            const referralFee = sellingPrice * (getValue('referralFee') / 100);
            const refundCost = sellingPrice * (getValue('refundRate') / 100);
            const totalCost = purchaseCost + headHaulCost + fbaFee + referralFee + adCost + storageFee + refundCost;
            const netProfitUsd = sellingPrice - totalCost;
            const netProfitCny = netProfitUsd * exchangeRate;
            const profitMargin = (sellingPrice > 0) ? (netProfitUsd / sellingPrice) * 100 : 0;
            const totalInvestment = purchaseCost + headHaulCost;
            const roi = (totalInvestment > 0) ? (netProfitUsd / totalInvestment) * 100 : 0;
            
            document.getElementById('headHaulCostResult').textContent = `${headHaulCost.toFixed(2)} USD`;
            document.getElementById('fbaFeeResult').textContent = `${fbaFee.toFixed(2)} USD`;
            document.getElementById('netProfitUsd').textContent = `${netProfitUsd.toFixed(2)} USD`;
            document.getElementById('netProfitCny').textContent = `Â¥${netProfitCny.toFixed(2)}`;
            document.getElementById('profitMargin').textContent = `${profitMargin.toFixed(2)}%`;
            document.getElementById('roi').textContent = `${roi.toFixed(2)}%`;
            
            [ 'netProfitUsd', 'netProfitCny', 'profitMargin', 'roi'].forEach(id => {
                const elem = document.getElementById(id);
                if (netProfitUsd < 0) {
                    elem.classList.add('negative');
                } else {
                    elem.classList.remove('negative');
                }
            });

            // Add to history
            const productName = document.getElementById('productName').value || 'æœªå‘½åäº§å“';
            const competitorLink = document.getElementById('competitorLink').value;
            const headHaulCostCny = headHaulCost * exchangeRate;
            const fbaFeeCny = fbaFee * exchangeRate;
            addHistoryRecord({
                id: Date.now(),
                productName,
                competitorLink,
                sellingPrice: sellingPrice.toFixed(2),
                purchaseCost: purchaseCost.toFixed(2),
                headHaulCostCny: headHaulCostCny.toFixed(2),
                fbaFeeCny: fbaFeeCny.toFixed(2),
                netProfitCny: netProfitCny.toFixed(2),
                profitMargin: profitMargin.toFixed(2)
            });
        }

        // --- Chrome Extension Integration ---
        function goToAmazonAndExtract() {
            const url = document.getElementById('competitorLink').value;
            const statusEl = document.getElementById('fetch-status');
            
            if (!url || (!url.includes('amazon.com') && !url.includes('amazon.cn'))) {
                statusEl.textContent = 'è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„äºšé©¬é€Šé“¾æ¥ã€‚';
                statusEl.style.color = '#dc3545';
                return;
            }
            
            console.warn('æœªæ£€æµ‹åˆ°Chromeæ’ä»¶ï¼Œå°†ç›´æ¥å°è¯•æ‰“å¼€é“¾æ¥ã€‚');
            
            statusEl.textContent = 'æ­£åœ¨è·³è½¬åˆ°Amazoné¡µé¢ï¼Œè¯·åœ¨æ–°é¡µé¢ä¸­ä½¿ç”¨æ’ä»¶æå–ä¿¡æ¯...';
            statusEl.style.color = '#007bff';
            
            window.open(url, '_blank');
        }
        
        function downloadExtension() {
            alert('æ’ä»¶æ–‡ä»¶ä¸‹è½½åŠŸèƒ½å¼€å‘ä¸­ã€‚è¯·è”ç³»ç®¡ç†å‘˜è·å–æ’ä»¶æ–‡ä»¶ã€‚');
        }
        
        function showInstallGuide() {
            const guideModal = document.createElement('div');
            guideModal.className = 'modal';
            guideModal.style.display = 'flex';
            guideModal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <span class="close-button" onclick="this.parentElement.parentElement.remove()">Ã—</span>
                    <h3>ğŸ”§ Chromeæ’ä»¶å®‰è£…æ•™ç¨‹</h3>
                    <div style="text-align: left; line-height: 1.6;">
                        <div class="step" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <strong>æ­¥éª¤ 1ï¼šä¸‹è½½æ’ä»¶æ–‡ä»¶</strong><br>
                            ç‚¹å‡»"ä¸‹è½½æ’ä»¶æ–‡ä»¶"æŒ‰é’®ï¼Œè·å–chrome-extensionæ–‡ä»¶å¤¹
                        </div>
                        <div class="step" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <strong>æ­¥éª¤ 2ï¼šæ‰“å¼€Chromeæ‰©å±•ç®¡ç†</strong><br>
                            åœ¨Chromeåœ°å€æ è¾“å…¥ï¼š<code>chrome://extensions/</code>
                        </div>
                        <div class="step" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <strong>æ­¥éª¤ 3ï¼šå¯ç”¨å¼€å‘è€…æ¨¡å¼</strong><br>
                            åœ¨é¡µé¢å³ä¸Šè§’å¼€å¯"å¼€å‘è€…æ¨¡å¼"å¼€å…³
                        </div>
                        <div class="step" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <strong>æ­¥éª¤ 4ï¼šåŠ è½½æ’ä»¶</strong><br>
                            ç‚¹å‡»"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº"ï¼Œé€‰æ‹©chrome-extensionæ–‡ä»¶å¤¹
                        </div>
                        <div class="step" style="margin: 15px 0; padding: 15px; background: #e8f5e8; border-radius: 8px;">
                            <strong>âœ… å®‰è£…æˆåŠŸï¼</strong><br>
                            æ’ä»¶å›¾æ ‡ä¼šå‡ºç°åœ¨Chromeå·¥å…·æ ä¸­ï¼Œç°åœ¨å¯ä»¥ä½¿ç”¨è‡ªåŠ¨æå–åŠŸèƒ½äº†
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(guideModal);
        }

        function showManualInputHelp() {
            const helpDiv = document.getElementById('manual-help');
            if (helpDiv) {
                helpDiv.style.display = 'block';
            }
        }

        // --- Preset Costs Logic ---
        function savePresetCosts() {
            const exchangeRate = document.getElementById('exchangeRate').value;
            const headHaulRate = document.getElementById('headHaulRate').value;
            localStorage.setItem('presetCosts', JSON.stringify({ exchangeRate, headHaulRate }));
        }

        function loadPresetCosts() {
            const savedPresets = localStorage.getItem('presetCosts');
            if (savedPresets) {
                const { exchangeRate, headHaulRate } = JSON.parse(savedPresets);
                if (exchangeRate) document.getElementById('exchangeRate').value = exchangeRate;
                if (headHaulRate) document.getElementById('headHaulRate').value = headHaulRate;
            }
        }

        // --- History Logic ---
        let calculationHistory = [];

        function renderHistory() {
            const tbody = document.getElementById('history-tbody');
            tbody.innerHTML = '';
            if (calculationHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;">æš‚æ— å†å²è®°å½•</td></tr>';
                return;
            }
            calculationHistory.forEach(record => {
                const tr = document.createElement('tr');
                tr.setAttribute('data-id', record.id);
                tr.innerHTML = `
                    <td>${escapeHTML(record.productName)}</td>
                    <td><a href="${escapeHTML(record.competitorLink)}" target="_blank" rel="noopener noreferrer">${escapeHTML(record.competitorLink)}</a></td>
                    <td>${record.sellingPrice || 'N/A'}</td>
                    <td>${record.purchaseCost}</td>
                    <td>${record.headHaulCostCny || 'N/A'}</td>
                    <td>${record.fbaFeeCny || 'N/A'}</td>
                    <td>${record.netProfitCny || 'N/A'}</td>
                    <td>${record.profitMargin}%</td>
                    <td><button class="delete-row-btn" onclick="deleteHistoryRecord(${record.id})">åˆ é™¤</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function saveHistory() {
            localStorage.setItem('calculationHistory', JSON.stringify(calculationHistory));
        }

        function loadHistory() {
            const savedHistory = localStorage.getItem('calculationHistory');
            if (savedHistory) {
                calculationHistory = JSON.parse(savedHistory);
            }
            renderHistory();
        }

        function addHistoryRecord(record) {
            calculationHistory.unshift(record);
            if (calculationHistory.length > 50) { // Limit history size
                calculationHistory.pop();
            }
            saveHistory();
            renderHistory();
        }

        function deleteHistoryRecord(id) {
            calculationHistory = calculationHistory.filter(record => record.id !== id);
            saveHistory();
            renderHistory();
        }

        function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ')) {
                calculationHistory = [];
                saveHistory();
                renderHistory();
            }
        }
        
        function escapeHTML(str) {
            if (!str) return '';
            return str.replace(/[&<>"']/g, function(match) {
                return {
                    '&': '&',
                    '<': '<',
                    '>': '>',
                    '"': '"',
                    "'": '&#39;'
                }[match];
            });
        }

        function exportToCSV() {
            if (calculationHistory.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„å†å²è®°å½•ã€‚');
                return;
            }

            const headers = ['äº§å“åç§°', 'ç«å“é“¾æ¥', 'å”®ä»· (USD)', 'é‡‡è´­æˆæœ¬ (USD)', 'å¤´ç¨‹ç‰©æµ (CNY)', 'FBAè´¹ç”¨ (CNY)', 'å‡€åˆ©æ¶¦ (CNY)', 'åˆ©æ¶¦ç‡ (%)'];
            let csvContent = '\uFEFF' + headers.join(',') + '\n';

            calculationHistory.forEach(record => {
                const row = [
                    `"${record.productName.replace(/"/g, '""')}"`,
                    `"${record.competitorLink}"`,
                    record.sellingPrice || 'N/A',
                    record.purchaseCost,
                    record.headHaulCostCny || 'N/A',
                    record.fbaFeeCny || 'N/A',
                    record.netProfitCny || 'N/A',
                    record.profitMargin
                ];
                csvContent += row.join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "amazon_profit_history.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ç”¨æ‰©å±•æ•°æ®å¡«å……è¡¨å•
        function fillFormWithExtensionData(data) {
            console.log('æ¥æ”¶åˆ°æ‰©å±•æ•°æ®:', data);
            
            if (data.title) document.getElementById('productName').value = data.title;
            if (data.weightKg > 0) document.getElementById('prodWeight').value = data.weightKg.toFixed(3);
            if (data.length > 0) document.getElementById('prodLength').value = data.length.toFixed(2);
            if (data.width > 0) document.getElementById('prodWidth').value = data.width.toFixed(2);
            if (data.height > 0) document.getElementById('prodHeight').value = data.height.toFixed(2);
            if (data.url) document.getElementById('competitorLink').value = data.url;
            
            const helpDiv = document.getElementById('manual-help');
            if (helpDiv) helpDiv.style.display = 'none';
        }

        // ç›‘å¬æ¥è‡ªæ‰©å±•çš„å®æ—¶æ¶ˆæ¯
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'AMAZON_PRODUCT_DATA') {
                fillFormWithExtensionData(event.data.data);
                const statusEl = document.getElementById('fetch-status');
                if (statusEl) {
                    statusEl.textContent = 'å·²æ¥æ”¶Chromeæ‰©å±•æ•°æ®ï¼';
                    statusEl.style.color = '#28a745';
                }
            }
        });

        // Modal functions
        function openModal() {
            document.getElementById("feedbackModal").style.display = "flex";
        }
        
        function closeModal() {
            document.getElementById("feedbackModal").style.display = "none";
        }

        function openDonate() {
            document.getElementById("donateModal").style.display = "flex";
        }
        
        function closeDonate() {
            document.getElementById("donateModal").style.display = "none";
        }

        // Load presets and history on page startup
        document.addEventListener('DOMContentLoaded', () => {
            loadPresetCosts();
            loadHistory();
            
            document.getElementById('exchangeRate').addEventListener('input', savePresetCosts);
            document.getElementById('headHaulRate').addEventListener('input', savePresetCosts);
            document.getElementById('productInfoPaste').addEventListener('input', parseAndFillInfo);
        });

    </script>

</body>
</html>