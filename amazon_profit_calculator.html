<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äºšé©¬é€Šäº§å“åˆ©æ¶¦è®¡ç®—å™¨ - AMZAIListing</title>
    <style>
        :root {
            --primary-color: #007bff;
            --bg-light: #f8f9fa;
            --bg-white: #ffffff;
            --text-main: #343a40;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
        }
        
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-light);
            color: var(--text-main);
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        
        header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: bold;
            letter-spacing: 1px;
            padding: 0;
        }
        
        #user-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        #user-actions .nav-btn {
            margin: 0;
            box-shadow: none;
            background: transparent;
            border: 1px solid white;
            color: white;
        }
        
        #user-actions .nav-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: white;
            color: white;
        }
        
        .nav-bar {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-top: 12px;
            position: relative;
            z-index: 2;
        }
        
        .nav-btn {
            background: #fff;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            border-radius: 999px;
            font-size: 18px;
            font-weight: 500;
            padding: 8px 32px;
            margin: 0 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }
        
        .nav-btn.active, .nav-btn:active {
            background: var(--primary-color);
            color: #fff;
            box-shadow: 0 4px 16px rgba(0,122,255,0.10);
            border-color: var(--primary-color);
        }
        
        .nav-btn:hover:not(.active) {
            box-shadow: 0 6px 20px rgba(0,122,255,0.13);
            border-color: var(--primary-color);
            color: var(--primary-color);
            background: rgba(0,122,255,0.1);
        }
        
        main {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: flex-start;
            gap: 32px;
            padding: 32px 8px 24px 8px;
            min-height: 60vh;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .form-container {
            flex: 2;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-white);
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            padding: 32px 24px;
            min-width: 320px;
            max-width: 800px;
        }
        
        .results-container {
            flex: 1;
            position: sticky;
            top: 20px;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-white);
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            padding: 32px 24px;
            min-width: 320px;
            max-width: 400px;
        }
        
        h2 {
            color: var(--primary-color);
            margin-bottom: 16px;
            font-size: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }
        
        .grid-container {
            display: grid;
            gap: 25px;
        }
        
        #presets-section .grid-container {
            grid-template-columns: repeat(3, 1fr);
        }
        
        #product-info-section .grid-container {
            grid-template-columns: repeat(4, 1fr);
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }
        
        .input-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }
        
        .input-group .input-wrapper {
            display: flex;
            align-items: center;
        }
        
        label {
            font-weight: 600;
            margin-bottom: 5px;
            display: block;
        }
        
        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            font-size: 16px;
            background-color: var(--bg-light);
            color: var(--text-main);
            box-sizing: border-box;
            min-height: 40px;
        }
        
        .input-group .input-wrapper > input {
            flex-grow: 1;
            border-radius: 12px 0 0 12px;
            border-right: none;
            min-width: 50px;
            margin-bottom: 0;
        }
        
        .input-group .input-wrapper > select, 
        .input-group .input-wrapper > .unit-label,
        .input-group .input-wrapper > .fetch-btn {
            border-radius: 0 12px 12px 0;
            margin-bottom: 0;
        }
        
        .input-group .input-wrapper > select, .input-group .input-wrapper > .unit-label {
            background-color: var(--bg-light);
            cursor: pointer;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-left: none;
        }
        
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            background-color: var(--bg-white);
        }
        
        .fetch-btn {
            padding: 12px 15px;
            border: 1px solid var(--primary-color);
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s;
            border-left: none;
        }
        
        .fetch-btn:hover {
            background-color: #005fcc;
        }
        
        .calculate-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            align-self: flex-start;
            margin-top: 24px;
            width: 100%;
        }
        
        .calculate-btn:hover {
            background-color: #005fcc;
        }
        
        .results {
            margin-top: 1rem;
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        .result-item {
            background-color: var(--bg-light);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .result-item h3 {
            margin: 0;
            color: var(--text-main);
            font-size: 15px;
            font-weight: 500;
            border: none;
            padding: 0;
        }
        
        .result-item .value {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary-color);
            word-wrap: break-word;
        }
        
        .result-item .value.negative { 
            color: #dc3545;
        }

        .full-width { grid-column: 1 / -1; }
        .span-2 { grid-column: span 2; }
        .span-3 { grid-column: span 3; }

        #fetch-status {
            font-size: 12px;
            color: #666;
            height: 1.5em;
            padding-top: 5px;
        }

        .extension-guide {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border: 1px solid #bbdefb;
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
            font-size: 14px;
            color: #1565c0;
        }

        .extension-guide h4 {
            margin: 0 0 15px 0;
            color: #1565c0;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .extension-guide .step {
            background: rgba(255,255,255,0.7);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            border-left: 4px solid var(--primary-color);
        }

        .extension-guide .step-number {
            background: var(--primary-color);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }

        .extension-guide .download-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin: 10px 10px 10px 0;
            transition: background-color 0.3s;
        }

        .extension-guide .download-btn:hover {
            background: #005fcc;
        }

        .extension-guide .secondary-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin: 10px 10px 10px 0;
            transition: background-color 0.3s;
        }

        .extension-guide .secondary-btn:hover {
            background: #218838;
        }

        .go-to-amazon-btn {
            background: #ff9900;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-left: 10px;
        }

        .go-to-amazon-btn:hover {
            background: #e68a00;
        }

        .manual-help {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 12px;
            padding: 15px;
            margin-top: 10px;
            font-size: 12px;
            color: #856404;
        }

        .manual-help h4 {
            margin: 0 0 10px 0;
            color: #856404;
            font-size: 14px;
        }

        .manual-help ul {
            margin: 5px 0;
            padding-left: 20px;
        }

        .manual-help li {
            margin-bottom: 5px;
        }

        #history-section {
            margin-top: 40px;
        }
        
        #history-section h2 {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-actions {
            display: flex;
            gap: 10px;
        }
        
        #clear-history-btn, #export-csv-btn {
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 12px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        #clear-history-btn {
            background-color: #dc3545;
        }
        
        #export-csv-btn {
            background-color: #28a745;
        }
        
        #clear-history-btn:hover {
            background-color: #c82333;
        }
        
        #export-csv-btn:hover {
            background-color: #218838;
        }
        
        .history-table-container {
            overflow-x: auto;
        }
        
        #history-section table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        #history-section th, #history-section td {
            border: 1px solid #e0e0e0;
            padding: 12px 15px;
            text-align: left;
            font-size: 14px;
            vertical-align: middle;
        }
        
        #history-section th {
            background-color: #f9f9f9;
            font-weight: 600;
        }
        
        #history-section td a {
            color: #007bff;
            text-decoration: none;
            word-break: break-all;
        }
        
        #history-section td a:hover {
            text-decoration: underline;
        }
        
        #history-section .delete-row-btn {
            background: none;
            border: none;
            color: #e74c3c;
            cursor: pointer;
            font-size: 16px;
            padding: 5px;
        }
        
        .site-footer {
            background-color: #343a40;
            padding: 24px 16px;
            text-align: center;
            color: white;
            font-size: 14px;
            border-top: none;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            margin-top: 40px;
            border-radius: 12px 12px 0 0;
            width: 100%;
            position: static;
        }
        
        .site-footer a {
            color: #ffffff;
            text-decoration: underline;
            font-weight: 500;
            margin: 0 8px;
        }
        
        .site-footer a:hover {
            text-decoration: none;
            opacity: 0.9;
        }
        
        .donate-button {
            position: fixed;
            right: 20px;
            bottom: 20px;
            background-color: #fd7e14;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 999px;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 999;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: #fff;
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            max-width: 800px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
        }
        
        .close-button {
            position: absolute;
            top: 10px;
            right: 14px;
            font-size: 20px;
            cursor: pointer;
        }

        @media (max-width: 1200px) {
            #presets-section .grid-container,
            #product-info-section .grid-container {
                grid-template-columns: repeat(2, 1fr);
            }
            .span-3 { grid-column: span 2; }
        }
        
        @media (max-width: 992px) {
            main {
                flex-direction: column;
                gap: 20px;
            }
            .results-container {
                position: static;
                width: 100%;
            }
            .nav-bar {
                flex-wrap: wrap;
                justify-content: center;
                gap: 10px;
            }
            .nav-btn {
                padding: 7px 16px;
                font-size: 15px;
            }
        }
        
        @media (max-width: 768px) {
            .form-container, .results-container { 
                padding: 20px; 
            }
            #presets-section .grid-container,
            #product-info-section .grid-container {
                grid-template-columns: 1fr;
            }
            .span-2, .span-3 { grid-column: span 1; }
            header h1 {
                font-size: 22px;
            }
            main {
                padding: 8px 2px 12px 2px;
            }
        }
        
        @media (max-width: 600px) {
            header h1 {
                font-size: 22px;
                padding: 18px 0 0 0;
            }
            .nav-btn {
                font-size: 15px;
                padding: 7px 16px;
            }
            .nav-bar {
                gap: 10px;
            }
            main {
                padding: 8px 2px 12px 2px;
            }
            .form-container, .results-container {
                padding: 12px 4px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>äºšé©¬é€Šäº§å“åˆ©æ¶¦è®¡ç®—å™¨</h1>
        <div id="user-actions">
            <a href="auth.html" class="nav-btn" id="auth-btn">ç™»å½•/æ³¨å†Œ</a>
        </div>
    </header>
    <nav class="nav-bar">
        <a href="index.html" class="nav-btn">Listingç”Ÿæˆå™¨</a>
        <a href="zhuangxiang.html" class="nav-btn">è£…ç®±è®¡ç®—å™¨</a>
        <a href="amazon_profit_calculator.html" class="nav-btn active">åˆ©æ¶¦è®¡ç®—å™¨</a>
        <a href="extension-download.html" class="nav-btn">ä¸‹è½½æ‰©å±•</a>
    </nav>
    <main>
        <div class="form-container">
            <section id="presets-section">
                <h2>é¢„è®¾æˆæœ¬ä¸è§„åˆ™</h2>
                <div class="grid-container">
                    <div class="input-group">
                        <label for="exchangeRate">ç¾å…ƒå¯¹äººæ°‘å¸æ±‡ç‡</label>
                        <input type="number" id="exchangeRate" value="7.25">
                    </div>
                    <div class="input-group">
                        <label for="headHaulRate">å¤´ç¨‹ç‰©æµå•ä»· (CNY/kg)</label>
                        <input type="number" id="headHaulRate" value="30">
                    </div>
                    <div class="input-group">
                        <label>FBAè®¡è´¹è§„åˆ™</label>
                        <div style="padding: 12px; border: 1px solid #eee; border-radius: 8px; background: #fafafa; font-size: 14px; height: 100%; box-sizing: border-box;">
                            åŸºäºç¾ç«™æ ‡å‡†å°ºå¯¸/å¤§ä»¶çš„ç®€åŒ–æ¨¡å‹è‡ªåŠ¨è®¡ç®—ã€‚
                        </div>
                    </div>
                </div>
            </section>

            <section id="product-info-section">
                <h2>äº§å“ä¿¡æ¯ä¸æˆæœ¬</h2>
                <div class="grid-container">
                    <div class="input-group full-width">
                        <label for="productName">äº§å“åç§°</label>
                        <input type="text" id="productName" placeholder="ä¾‹å¦‚: æ™ºèƒ½é¢ˆéƒ¨æŒ‰æ‘©ä»ª">
                    </div>
                    <div class="input-group full-width">
                        <label for="competitorLink">å‚è€ƒç«å“é“¾æ¥ (Chromeæ’ä»¶è‡ªåŠ¨è·å–)</label>
                        <div class="input-wrapper">
                            <input type="url" id="competitorLink" placeholder="ç²˜è´´äºšé©¬é€Šå•†å“é“¾æ¥">
                            <button class="go-to-amazon-btn" onclick="goToAmazonAndExtract()">è·³è½¬æå–</button>
                        </div>
                        <div id="fetch-status"></div>
                        
                        <div id="extension-guide" class="extension-guide">
                            <h4>ğŸš€ ä½¿ç”¨Chromeæ’ä»¶è‡ªåŠ¨æå–äº§å“ä¿¡æ¯</h4>
                            
                            <div class="step">
                                <span class="step-number">1</span>
                                <strong>å®‰è£…Chromeæ’ä»¶ï¼š</strong>
                                <br>
                                <a href="#" class="download-btn" onclick="downloadExtension()">ğŸ“¥ ä¸‹è½½æ’ä»¶æ–‡ä»¶</a>
                                <a href="#" class="secondary-btn" onclick="showInstallGuide()">ğŸ“– æŸ¥çœ‹å®‰è£…æ•™ç¨‹</a>
                            </div>
                            
                            <div class="step">
                                <span class="step-number">2</span>
                                <strong>ä½¿ç”¨æ–¹æ³•ï¼š</strong>
                                <br>â€¢ ç²˜è´´Amazonå•†å“é“¾æ¥åˆ°ä¸Šæ–¹è¾“å…¥æ¡†
                                <br>â€¢ ç‚¹å‡»"è·³è½¬æå–"æŒ‰é’®è‡ªåŠ¨è·³è½¬åˆ°Amazoné¡µé¢
                                <br>â€¢ æ’ä»¶ä¼šè‡ªåŠ¨æå–äº§å“ä¿¡æ¯å¹¶è¿”å›åˆ°æœ¬é¡µé¢
                            </div>
                            
                            <div class="step">
                                <span class="step-number">3</span>
                                <strong>æ”¯æŒçš„ä¿¡æ¯ï¼š</strong>
                                <br>â€¢ äº§å“åç§°ã€é‡é‡ã€å°ºå¯¸ï¼ˆé•¿å®½é«˜ï¼‰
                                <br>â€¢ è‡ªåŠ¨å•ä½è½¬æ¢ï¼ˆè‹±åˆ¶â†’å…¬åˆ¶ï¼‰
                                <br>â€¢ æ™ºèƒ½è§£æå¤šç§Amazoné¡µé¢æ ¼å¼
                            </div>
                        </div>
                        
                        <div id="manual-help" class="manual-help" style="display: none;">
                            <h4>æ‰‹åŠ¨å¡«å†™æŒ‡å—ï¼š</h4>
                            <ul>
                                <li>åœ¨Amazonå•†å“é¡µé¢æ‰¾åˆ°"Product details"æˆ–"Technical Details"éƒ¨åˆ†</li>
                                <li>æŸ¥æ‰¾"Product Dimensions"æˆ–"Package Dimensions"è·å–å°ºå¯¸</li>
                                <li>æŸ¥æ‰¾"Item Weight"æˆ–"Shipping Weight"è·å–é‡é‡</li>
                                <li>å¦‚æœæ˜¯è‹±åˆ¶å•ä½ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è½¬æ¢ä¸ºå…¬åˆ¶</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label for="prodWeight">äº§å“é‡é‡ (kg)</label>
                        <input type="number" id="prodWeight" placeholder="0.8">
                    </div>
                    <div class="input-group">
                        <label for="prodLength">é•¿ (cm)</label>
                        <input type="number" id="prodLength" placeholder="æœ€é•¿è¾¹">
                    </div>
                    <div class="input-group">
                        <label for="prodWidth">å®½ (cm)</label>
                        <input type="number" id="prodWidth" placeholder="ä¸­é—´è¾¹">
                    </div>
                    <div class="input-group">
                        <label for="prodHeight">é«˜ (cm)</label>
                        <input type="number" id="prodHeight" placeholder="æœ€çŸ­è¾¹">
                    </div>

                    <div class="input-group span-2">
                        <label for="sellingPrice">äº§å“å”®ä»·</label>
                        <div class="input-wrapper">
                            <input type="number" id="sellingPrice" placeholder="29.99">
                            <select id="sellingPriceCurrency"><option value="USD" selected>USD</option><option value="CNY">CNY</option></select>
                        </div>
                    </div>
                    <div class="input-group span-2">
                        <label for="purchaseCost">äº§å“é‡‡è´­æˆæœ¬</label>
                        <div class="input-wrapper">
                            <input type="number" id="purchaseCost" placeholder="35.00">
                            <select id="purchaseCostCurrency"><option value="USD">USD</option><option value="CNY" selected>CNY</option></select>
                        </div>
                    </div>
                    
                    <div class="input-group span-2">
                        <label for="referralFee">é”€å”®ä½£é‡‘ç‡ (%)</label>
                        <input type="number" id="referralFee" value="15">
                    </div>
                    <div class="input-group span-2">
                        <label for="refundRate">é¢„ä¼°é€€æ¬¾åæŸç‡ (%)</label>
                        <input type="number" id="refundRate" value="0">
                    </div>

                     <div class="input-group span-2">
                        <label for="adCost">é¢„ä¼°å¹¿å‘Šæˆæœ¬ (å•ä»¶)</label>
                        <div class="input-wrapper">
                            <input type="number" id="adCost" value="0">
                            <select id="adCostCurrency"><option value="USD" selected>USD</option><option value="CNY">CNY</option></select>
                        </div>
                    </div>
                    <div class="input-group span-2">
                        <label for="storageFee">å…¶ä»–æˆæœ¬ (ä»“å‚¨/åŒ…è£…ç­‰)</label>
                        <div class="input-wrapper">
                            <input type="number" id="storageFee" value="0">
                            <select id="storageFeeCurrency"><option value="USD" selected>USD</option><option value="CNY">CNY</option></select>
                        </div>
                    </div>
                </div>
            </section>

            <button class="calculate-btn" onclick="calculateProfit()">è®¡ç®—åˆ©æ¶¦</button>

            <section id="history-section">
                <h2>
                    <span>è®¡ç®—å†å²</span>
                    <div class="history-actions">
                        <button id="export-csv-btn" onclick="exportToCSV()">å¯¼å‡ºä¸º CSV</button>
                        <button id="clear-history-btn" onclick="clearHistory()">æ¸…ç©ºå†å²</button>
                    </div>
                </h2>
                <div class="history-table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>äº§å“åç§°</th>
                                <th>ç«å“é“¾æ¥</th>
                                <th>å”®ä»· (USD)</th>
                                <th>é‡‡è´­æˆæœ¬ (USD)</th>
                                <th>å¤´ç¨‹ç‰©æµ (CNY)</th>
                                <th>FBAè´¹ç”¨ (CNY)</th>
                                <th>å‡€åˆ©æ¶¦ (CNY)</th>
                                <th>åˆ©æ¶¦ç‡</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="history-tbody">
                            <!-- History records will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </section>
        </div>

        <div class="results-container">
            <h2>è®¡ç®—ç»“æœ</h2>
            <div class="results">
                <div class="result-item">
                    <h3>å¤´ç¨‹ç‰©æµ (USD)</h3>
                    <span class="value" id="headHaulCostResult">-$--.--</span>
                </div>
                <div class="result-item">
                    <h3>FBAè´¹ç”¨ (USD)</h3>
                    <span class="value" id="fbaFeeResult">-$--.--</span>
                </div>
                <div class="result-item">
                    <h3>å‡€åˆ©æ¶¦ (USD)</h3>
                    <span class="value" id="netProfitUsd">-$--.--</span>
                </div>
                <div class="result-item">
                    <h3>å‡€åˆ©æ¶¦ (CNY)</h3>
                    <span class="value" id="netProfitCny">Â¥--.--</span>
                </div>
                <div class="result-item">
                    <h3>åˆ©æ¶¦ç‡</h3>
                    <span class="value" id="profitMargin">--.--%</span>
                </div>
                <div class="result-item">
                    <h3>æŠ•èµ„å›æŠ¥ç‡ (ROI)</h3>
                    <span class="value" id="roi">--.--%</span>
                </div>
            </div>
        </div>
    </main>
    
    <footer class="site-footer">
        <div class="footer-content">
            <p>Â© 2025 äºšé©¬é€Š Listing æé€Ÿç”Ÿæˆå™¨</p>
            <p>
                <a href="privacy-policy.html">éšç§æ”¿ç­–</a> |
                <a href="terms-of-service.html">æœåŠ¡æ¡æ¬¾</a> |
                <a href="about-us.html">å…³äºæˆ‘ä»¬</a> |
                <a href="mailto:gskanchan@163.com">è”ç³»æˆ‘ä»¬</a> |
                <a href="javascript:void(0);" onclick="openModal()">æäº¤åé¦ˆ</a>
            </p>
        </div>
    </footer>
    
    <div id="feedbackModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">Ã—</span>
            <iframe src="https://uqi0gjbiwfl.feishu.cn/share/base/form/shrcn0RZevoq7QLVvGN6U5gojqb"
                    frameborder="0" width="100%" height="700" style="border-radius: 12px;"></iframe>
        </div>
    </div>
    
    <div id="donateModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeDonate()">Ã—</span>
            <h3>â˜• è¯·æˆ‘å–æ¯å¥¶èŒ¶å§ï¼</h3>
            <img src="donate.png" alt="æ‰“èµäºŒç»´ç " style="max-width: 300px; width: 100%; border-radius: 10px;"/>
            <p style="margin-top: 10px;">é•¿æŒ‰æˆ–æ‰«ç æ”¯ä»˜ï¼Œæ„Ÿè°¢ä½ çš„æ”¯æŒï¼ğŸ¥°</p>
        </div>
    </div>
    
    <button onclick="openDonate()" class="donate-button">ğŸ’— è¯·æˆ‘å–å¥¶èŒ¶</button>

    <script>
        // --- FBA & Cost Calculation Logic ---
        const FBA_FEES = {
            standard: { 0.25: 3.22, 0.5: 3.40, 0.75: 3.58, 1.0: 3.77, 1.5: 4.15, 2.0: 4.53, 2.5: 4.93, 3.0: 5.43, over_3_base: 5.43, over_3_per_lb: 0.38 },
            oversize: { base: 9.73, per_lb_over_1: 0.42 }
        };
        
        function getValue(id) { return parseFloat(document.getElementById(id).value) || 0; }
        
        function getValueInUSD(id, exchangeRate) {
            const value = getValue(id);
            const currency = document.getElementById(id + 'Currency').value;
            if (currency === 'CNY') { return value / exchangeRate; }
            return value;
        }
        
        function calculateHeadHaulCost(weightKg, rateCnyPerKg, exchangeRate) {
            if (weightKg <= 0 || rateCnyPerKg <= 0) return 0;
            return (weightKg * rateCnyPerKg) / exchangeRate;
        }
        
        function calculateFbaFee(weightKg, lengthCm, widthCm, heightCm) {
            if (weightKg <= 0 || lengthCm <= 0 || widthCm <= 0 || heightCm <= 0) return 0;
            const weightLb = weightKg * 2.20462;
            const dims = [(lengthCm / 2.54), (widthCm / 2.54), (heightCm / 2.54)].sort((a, b) => b - a);
            let tier = (dims[0] > 18 || dims[1] > 14 || dims[2] > 8 || weightLb > 20) ? 'oversize' : 'standard';
            let shippingWeight = Math.max(weightLb, (dims[0] * dims[1] * dims[2]) / 139);
            if (tier === 'standard') {
                 const weightTiers = Object.keys(FBA_FEES.standard).filter(k => !k.startsWith('over')).map(parseFloat);
                 for (const tierWeight of weightTiers) {
                     if (shippingWeight <= tierWeight) return FBA_FEES.standard[tierWeight.toString()];
                 }
                 return FBA_FEES.standard.over_3_base + Math.ceil(shippingWeight - 3) * FBA_FEES.standard.over_3_per_lb;
            } else {
                const roundedWeight = Math.ceil(shippingWeight);
                return FBA_FEES.oversize.base + (roundedWeight > 1 ? (roundedWeight - 1) * FBA_FEES.oversize.per_lb_over_1 : 0);
            }
        }
        
        function calculateProfit() {
            const exchangeRate = getValue('exchangeRate');
            if (!exchangeRate || exchangeRate <= 0) { alert('è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„æ­£æ•°æ±‡ç‡ï¼'); return; }
            const prodWeight = getValue('prodWeight');
            const prodLength = getValue('prodLength');
            const prodWidth = getValue('prodWidth');
            const prodHeight = getValue('prodHeight');
            const sellingPrice = getValueInUSD('sellingPrice', exchangeRate);
            const purchaseCost = getValueInUSD('purchaseCost', exchangeRate);
            const adCost = getValueInUSD('adCost', exchangeRate);
            const storageFee = getValueInUSD('storageFee', exchangeRate);
            const headHaulCost = calculateHeadHaulCost(prodWeight, getValue('headHaulRate'), exchangeRate);
            const fbaFee = calculateFbaFee(prodWeight, prodLength, prodWidth, prodHeight);
            if (sellingPrice === 0) { alert('è¯·è¾“å…¥äº§å“å”®ä»·ï¼'); return; }
            if (fbaFee === 0 && prodWeight > 0) { console.warn('æ— æ³•è®¡ç®—FBAè´¹ç”¨ï¼Œè¯·æ£€æŸ¥äº§å“å°ºå¯¸å’Œé‡é‡ã€‚'); }
            const referralFee = sellingPrice * (getValue('referralFee') / 100);
            const refundCost = sellingPrice * (getValue('refundRate') / 100);
            const totalCost = purchaseCost + headHaulCost + fbaFee + referralFee + adCost + storageFee + refundCost;
            const netProfitUsd = sellingPrice - totalCost;
            const netProfitCny = netProfitUsd * exchangeRate;
            const profitMargin = (sellingPrice > 0) ? (netProfitUsd / sellingPrice) * 100 : 0;
            const totalInvestment = purchaseCost + headHaulCost;
            const roi = (totalInvestment > 0) ? (netProfitUsd / totalInvestment) * 100 : 0;
            document.getElementById('headHaulCostResult').textContent = `${headHaulCost.toFixed(2)} USD`;
            document.getElementById('fbaFeeResult').textContent = `${fbaFee.toFixed(2)} USD`;
            document.getElementById('netProfitUsd').textContent = `${netProfitUsd.toFixed(2)} USD`;
            document.getElementById('netProfitCny').textContent = `Â¥${netProfitCny.toFixed(2)}`;
            document.getElementById('profitMargin').textContent = `${profitMargin.toFixed(2)}%`;
            document.getElementById('roi').textContent = `${roi.toFixed(2)}%`;
            [ 'netProfitUsd', 'netProfitCny', 'profitMargin', 'roi'].forEach(id => {
                const elem = document.getElementById(id).parentElement;
                netProfitUsd < 0 ? elem.querySelector('.value').classList.add('negative') : elem.querySelector('.value').classList.remove('negative');
            });

            // Add to history
            const productName = document.getElementById('productName').value || 'æœªå‘½åäº§å“';
            const competitorLink = document.getElementById('competitorLink').value;
            const headHaulCostCny = headHaulCost * exchangeRate;
            const fbaFeeCny = fbaFee * exchangeRate;
            addHistoryRecord({
                id: Date.now(),
                productName,
                competitorLink,
                sellingPrice: sellingPrice.toFixed(2),
                purchaseCost: purchaseCost.toFixed(2),
                headHaulCostCny: headHaulCostCny.toFixed(2),
                fbaFeeCny: fbaFeeCny.toFixed(2),
                netProfitCny: netProfitCny.toFixed(2),
                profitMargin: profitMargin.toFixed(2)
            });
        }

        // --- Chrome Extension Integration ---
        function goToAmazonAndExtract() {
            const url = document.getElementById('competitorLink').value;
            const statusEl = document.getElementById('fetch-status');
            
            if (!url || (!url.includes('amazon.com') && !url.includes('amazon.cn'))) {
                statusEl.textContent = 'è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„äºšé©¬é€Šé“¾æ¥ã€‚';
                statusEl.style.color = '#dc3545';
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦å®‰è£…äº†æ’ä»¶
            if (!isExtensionInstalled()) {
                statusEl.textContent = 'è¯·å…ˆå®‰è£…Chromeæ’ä»¶ï¼ç‚¹å‡»ä¸Šæ–¹"ä¸‹è½½æ’ä»¶æ–‡ä»¶"æŒ‰é’®ã€‚';
                statusEl.style.color = '#dc3545';
                showInstallGuide();
                return;
            }
            
            statusEl.textContent = 'æ­£åœ¨è·³è½¬åˆ°Amazoné¡µé¢ï¼Œè¯·åœ¨æ–°é¡µé¢ä¸­ä½¿ç”¨æ’ä»¶æå–ä¿¡æ¯...';
            statusEl.style.color = '#007bff';
            
            // åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€Amazoné“¾æ¥
            const newWindow = window.open(url, '_blank');
            
            // è®¾ç½®ä¸€ä¸ªæ ‡è¯†ï¼Œè¡¨ç¤ºç”¨æˆ·æ˜¯ä»åˆ©æ¶¦è®¡ç®—å™¨è·³è½¬è¿‡å»çš„
            localStorage.setItem('calculatorReturnUrl', window.location.href);
            localStorage.setItem('extractionInProgress', 'true');
            
            // ç›‘å¬æ’ä»¶è¿”å›çš„æ•°æ®
            const checkInterval = setInterval(() => {
                const extractionData = localStorage.getItem('amazonProductData');
                if (extractionData) {
                    clearInterval(checkInterval);
                    statusEl.textContent = 'æˆåŠŸæ¥æ”¶åˆ°äº§å“ä¿¡æ¯ï¼';
                    statusEl.style.color = '#28a745';
                    
                    // å¤„ç†æ¥æ”¶åˆ°çš„æ•°æ®
                    receiveExtensionData();
                    
                    // æ¸…ç†æ ‡è¯†
                    localStorage.removeItem('extractionInProgress');
                }
            }, 1000);
            
            // 30ç§’ååœæ­¢ç›‘å¬
            setTimeout(() => {
                clearInterval(checkInterval);
                if (localStorage.getItem('extractionInProgress')) {
                    statusEl.textContent = 'ç­‰å¾…è¶…æ—¶ã€‚è¯·ç¡®ä¿å·²å®‰è£…æ’ä»¶å¹¶åœ¨Amazoné¡µé¢ä¸­ç‚¹å‡»æ’ä»¶å›¾æ ‡ã€‚';
                    statusEl.style.color = '#ffc107';
                    localStorage.removeItem('extractionInProgress');
                }
            }, 30000);
        }
        
        function isExtensionInstalled() {
            // ç®€å•æ£€æŸ¥ï¼šçœ‹æ˜¯å¦æœ‰æ’ä»¶è®¾ç½®çš„æ ‡è¯†
            return localStorage.getItem('amazonExtensionInstalled') === 'true';
        }
        
        function downloadExtension() {
            // åˆ›å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰æ’ä»¶æ–‡ä»¶çš„zipä¸‹è½½
            const statusEl = document.getElementById('fetch-status');
            statusEl.textContent = 'æ’ä»¶æ–‡ä»¶å·²å‡†å¤‡å¥½ï¼Œè¯·æŒ‰ç…§å®‰è£…æ•™ç¨‹è¿›è¡Œå®‰è£…ã€‚';
            statusEl.style.color = '#007bff';
            
            // æ˜¾ç¤ºå®‰è£…æŒ‡å—
            showInstallGuide();
            
            // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„æ–‡ä»¶ä¸‹è½½é€»è¾‘
            alert('æ’ä»¶æ–‡ä»¶ä¸‹è½½åŠŸèƒ½å¼€å‘ä¸­ã€‚è¯·è”ç³»ç®¡ç†å‘˜è·å–æ’ä»¶æ–‡ä»¶ã€‚\n\næˆ–è€…æ‚¨å¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ‰‹åŠ¨åˆ›å»ºæ’ä»¶ï¼š\n1. åˆ›å»ºchrome-extensionæ–‡ä»¶å¤¹\n2. å¤åˆ¶manifest.jsonç­‰æ–‡ä»¶\n3. åœ¨Chromeä¸­åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº');
        }
        
        function showInstallGuide() {
            const guideModal = document.createElement('div');
            guideModal.className = 'modal';
            guideModal.style.display = 'flex';
            guideModal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <span class="close-button" onclick="this.parentElement.parentElement.remove()">Ã—</span>
                    <h3>ğŸ”§ Chromeæ’ä»¶å®‰è£…æ•™ç¨‹</h3>
                    <div style="text-align: left; line-height: 1.6;">
                        <div class="step" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <strong>æ­¥éª¤ 1ï¼šä¸‹è½½æ’ä»¶æ–‡ä»¶</strong><br>
                            ç‚¹å‡»"ä¸‹è½½æ’ä»¶æ–‡ä»¶"æŒ‰é’®ï¼Œè·å–chrome-extensionæ–‡ä»¶å¤¹
                        </div>
                        <div class="step" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <strong>æ­¥éª¤ 2ï¼šæ‰“å¼€Chromeæ‰©å±•ç®¡ç†</strong><br>
                            åœ¨Chromeåœ°å€æ è¾“å…¥ï¼š<code>chrome://extensions/</code>
                        </div>
                        <div class="step" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <strong>æ­¥éª¤ 3ï¼šå¯ç”¨å¼€å‘è€…æ¨¡å¼</strong><br>
                            åœ¨é¡µé¢å³ä¸Šè§’å¼€å¯"å¼€å‘è€…æ¨¡å¼"å¼€å…³
                        </div>
                        <div class="step" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <strong>æ­¥éª¤ 4ï¼šåŠ è½½æ’ä»¶</strong><br>
                            ç‚¹å‡»"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº"ï¼Œé€‰æ‹©chrome-extensionæ–‡ä»¶å¤¹
                        </div>
                        <div class="step" style="margin: 15px 0; padding: 15px; background: #e8f5e8; border-radius: 8px;">
                            <strong>âœ… å®‰è£…æˆåŠŸï¼</strong><br>
                            æ’ä»¶å›¾æ ‡ä¼šå‡ºç°åœ¨Chromeå·¥å…·æ ä¸­ï¼Œç°åœ¨å¯ä»¥ä½¿ç”¨è‡ªåŠ¨æå–åŠŸèƒ½äº†
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(guideModal);
        }

        // --- Legacy Amazon Data Fetching Logic (Fallback) ---
        async function fetchProductInfo() {
            const statusEl = document.getElementById('fetch-status');
            statusEl.textContent = 'å»ºè®®ä½¿ç”¨Chromeæ’ä»¶è¿›è¡Œä¿¡æ¯æå–ï¼ŒæˆåŠŸç‡æ›´é«˜ï¼';
            statusEl.style.color = '#ffc107';
            
            // æ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥æç¤º
            showManualInputHelp();
        }

        function parseProductInfo(doc) {
            console.log('å¼€å§‹è§£æäº§å“ä¿¡æ¯...');
            
            let foundDim = false;
            let foundWt = false;
            
            // æ–¹æ³•1: å°è¯•ä»è¯¦ç»†ä¿¡æ¯åŒºåŸŸè§£æ
            const result1 = parseFromDetailBullets(doc);
            foundDim = result1.foundDim || foundDim;
            foundWt = result1.foundWt || foundWt;
            
            // æ–¹æ³•2: å°è¯•ä»æŠ€æœ¯è¯¦æƒ…è¡¨æ ¼è§£æ
            if (!foundDim || !foundWt) {
                const result2 = parseFromTechDetails(doc);
                foundDim = result2.foundDim || foundDim;
                foundWt = result2.foundWt || foundWt;
            }
            
            // æ–¹æ³•3: å°è¯•ä»äº§å“ç‰¹æ€§åŒºåŸŸè§£æ
            if (!foundDim || !foundWt) {
                const result3 = parseFromFeatures(doc);
                foundDim = result3.foundDim || foundDim;
                foundWt = result3.foundWt || foundWt;
            }
            
            // æ–¹æ³•4: å°è¯•ä»JSON-LDç»“æ„åŒ–æ•°æ®è§£æ
            if (!foundDim || !foundWt) {
                const result4 = parseFromStructuredData(doc);
                foundDim = result4.foundDim || foundDim;
                foundWt = result4.foundWt || foundWt;
            }
            
            console.log(`è§£æç»“æœ: å°ºå¯¸=${foundDim}, é‡é‡=${foundWt}`);
            return foundDim || foundWt;
        }

        function parseFromDetailBullets(doc) {
            const detailList = doc.querySelector('#detailBullets_feature_div ul');
            if (!detailList) return { foundDim: false, foundWt: false };

            let dimensionsStr = '';
            let weightStr = '';

            const listItems = detailList.querySelectorAll('li');
            listItems.forEach(li => {
                const boldSpan = li.querySelector('span.a-text-bold');
                if (boldSpan) {
                    const label = boldSpan.textContent.trim().toLowerCase();
                    const valueSpan = boldSpan.parentElement.querySelectorAll('span')[1];
                    if (!valueSpan) return;

                    if (label.includes('dimensions') || label.includes('product dimensions')) {
                        dimensionsStr = valueSpan.textContent.trim();
                    }
                    if (label.includes('item weight') || label.includes('weight')) {
                        weightStr = valueSpan.textContent.trim();
                    }
                }
            });

            let foundDim = false;
            let foundWt = false;

            if (dimensionsStr) {
                foundDim = parseDimensions(dimensionsStr);
            }
            
            if (weightStr) {
                foundWt = parseAndSetWeight(weightStr);
            }
            
            return { foundDim, foundWt };
        }
        
        function parseFromTechDetails(doc) {
            let foundDim = false;
            let foundWt = false;
            
            // æŸ¥æ‰¾æŠ€æœ¯è¯¦æƒ…è¡¨æ ¼
            const tables = doc.querySelectorAll('table');
            tables.forEach(table => {
                const rows = table.querySelectorAll('tr');
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td, th');
                    if (cells.length >= 2) {
                        const label = cells[0].textContent.trim().toLowerCase();
                        const value = cells[1].textContent.trim();
                        
                        if ((label.includes('dimensions') || label.includes('size')) && !foundDim) {
                            foundDim = parseDimensions(value);
                        }
                        if ((label.includes('weight') || label.includes('é‡é‡')) && !foundWt) {
                            foundWt = parseAndSetWeight(value);
                        }
                    }
                });
            });
            
            return { foundDim, foundWt };
        }
        
        function parseFromFeatures(doc) {
            let foundDim = false;
            let foundWt = false;
            
            // æŸ¥æ‰¾äº§å“ç‰¹æ€§åŒºåŸŸ
            const featureSelectors = [
                '#feature-bullets ul li',
                '.a-unordered-list .a-list-item',
                '[data-feature-name] .a-list-item'
            ];
            
            featureSelectors.forEach(selector => {
                const items = doc.querySelectorAll(selector);
                items.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    if ((text.includes('dimensions') || text.includes('size')) && !foundDim) {
                        foundDim = parseDimensions(item.textContent);
                    }
                    if (text.includes('weight') && !foundWt) {
                        foundWt = parseAndSetWeight(item.textContent);
                    }
                });
            });
            
            return { foundDim, foundWt };
        }
        
        function parseFromStructuredData(doc) {
            let foundDim = false;
            let foundWt = false;
            
            // æŸ¥æ‰¾JSON-LDç»“æ„åŒ–æ•°æ®
            const scripts = doc.querySelectorAll('script[type="application/ld+json"]');
            scripts.forEach(script => {
                try {
                    const data = JSON.parse(script.textContent);
                    if (data.offers && data.offers.length > 0) {
                        const offer = data.offers[0];
                        if (offer.itemOffered) {
                            const item = offer.itemOffered;
                            if (item.weight && !foundWt) {
                                foundWt = parseAndSetWeight(item.weight);
                            }
                            if (item.dimensions && !foundDim) {
                                foundDim = parseDimensions(JSON.stringify(item.dimensions));
                            }
                        }
                    }
                } catch (e) {
                    // å¿½ç•¥JSONè§£æé”™è¯¯
                }
            });
            
            return { foundDim, foundWt };
        }
        
        function parseDimensions(dimensionsStr) {
            if (!dimensionsStr) return false;
            
            // æ”¯æŒå¤šç§æ ¼å¼çš„å°ºå¯¸è§£æ
            const patterns = [
                /(\d+\.?\d*)\s*[xÃ—]\s*(\d+\.?\d*)\s*[xÃ—]\s*(\d+\.?\d*)\s*(inches?|in|cm|centimeters?)/i,
                /(\d+\.?\d*)\s*[xÃ—]\s*(\d+\.?\d*)\s*[xÃ—]\s*(\d+\.?\d*)/i,
                /é•¿[ï¼š:]\s*(\d+\.?\d*)\s*cm.*å®½[ï¼š:]\s*(\d+\.?\d*)\s*cm.*é«˜[ï¼š:]\s*(\d+\.?\d*)\s*cm/i
            ];
            
            for (const pattern of patterns) {
                const match = dimensionsStr.match(pattern);
                if (match) {
                    let l = parseFloat(match[1]);
                    let w = parseFloat(match[2]);
                    let h = parseFloat(match[3]);
                    
                    // å•ä½è½¬æ¢
                    if (match[4] && (match[4].toLowerCase().includes('inch') || match[4].toLowerCase().includes('in'))) {
                        l *= 2.54; w *= 2.54; h *= 2.54;
                    }
                    
                    // æŒ‰å¤§å°æ’åº
                    const dims = [l, w, h].sort((a,b) => b-a);
                    document.getElementById('prodLength').value = dims[0].toFixed(2);
                    document.getElementById('prodWidth').value = dims[1].toFixed(2);
                    document.getElementById('prodHeight').value = dims[2].toFixed(2);
                    
                    return true;
                }
            }
            
            return false;
        }

        function parseAndSetWeight(text) {
            if (!text) return false;
            const weightMatch = text.match(/(\d+\.?\d*)\s*(pounds|ounces|kg|kilograms|g|grams)/i);
            if (weightMatch) {
                let weight = parseFloat(weightMatch[1]);
                const unit = weightMatch[2].toLowerCase();
                if (unit === 'pounds') weight *= 0.453592;
                if (unit === 'ounces') weight *= 0.0283495;
                if (unit === 'g' || unit === 'grams') weight /= 1000;
                document.getElementById('prodWeight').value = weight.toFixed(3);
                return true;
            }
            return false;
        }

        function showManualInputHelp() {
            const helpDiv = document.getElementById('manual-help');
            if (helpDiv) {
                helpDiv.style.display = 'block';
            }
        }

        // --- Preset Costs Logic ---
        function savePresetCosts() {
            const exchangeRate = document.getElementById('exchangeRate').value;
            const headHaulRate = document.getElementById('headHaulRate').value;
            localStorage.setItem('presetCosts', JSON.stringify({ exchangeRate, headHaulRate }));
        }

        function loadPresetCosts() {
            const savedPresets = localStorage.getItem('presetCosts');
            if (savedPresets) {
                const { exchangeRate, headHaulRate } = JSON.parse(savedPresets);
                if (exchangeRate) document.getElementById('exchangeRate').value = exchangeRate;
                if (headHaulRate) document.getElementById('headHaulRate').value = headHaulRate;
            }
        }

        // --- History Logic ---
        let calculationHistory = [];

        function renderHistory() {
            const tbody = document.getElementById('history-tbody');
            tbody.innerHTML = '';
            if (calculationHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;">æš‚æ— å†å²è®°å½•</td></tr>';
                return;
            }
            calculationHistory.forEach(record => {
                const tr = document.createElement('tr');
                tr.setAttribute('data-id', record.id);
                tr.innerHTML = `
                    <td>${escapeHTML(record.productName)}</td>
                    <td><a href="${escapeHTML(record.competitorLink)}" target="_blank" rel="noopener noreferrer">${escapeHTML(record.competitorLink)}</a></td>
                    <td>${record.sellingPrice || 'N/A'}</td>
                    <td>${record.purchaseCost}</td>
                    <td>${record.headHaulCostCny || 'N/A'}</td>
                    <td>${record.fbaFeeCny || 'N/A'}</td>
                    <td>${record.netProfitCny || 'N/A'}</td>
                    <td>${record.profitMargin}%</td>
                    <td><button class="delete-row-btn" onclick="deleteHistoryRecord(${record.id})">åˆ é™¤</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function saveHistory() {
            localStorage.setItem('calculationHistory', JSON.stringify(calculationHistory));
        }

        function loadHistory() {
            const savedHistory = localStorage.getItem('calculationHistory');
            if (savedHistory) {
                calculationHistory = JSON.parse(savedHistory);
            }
            renderHistory();
        }

        function addHistoryRecord(record) {
            calculationHistory.unshift(record);
            saveHistory();
            renderHistory();
        }

        function deleteHistoryRecord(id) {
            calculationHistory = calculationHistory.filter(record => record.id !== id);
            saveHistory();
            renderHistory();
        }

        function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ')) {
                calculationHistory = [];
                saveHistory();
                renderHistory();
            }
        }
        
        function escapeHTML(str) {
            if (!str) return '';
            return str.replace(/[&<>"']/g, function(match) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[match];
            });
        }

        function exportToCSV() {
            if (calculationHistory.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„å†å²è®°å½•ã€‚');
                return;
            }

            const headers = ['äº§å“åç§°', 'ç«å“é“¾æ¥', 'å”®ä»· (USD)', 'é‡‡è´­æˆæœ¬ (USD)', 'å¤´ç¨‹ç‰©æµ (CNY)', 'FBAè´¹ç”¨ (CNY)', 'å‡€åˆ©æ¶¦ (CNY)', 'åˆ©æ¶¦ç‡ (%)'];
            let csvContent = '\uFEFF' + headers.join(',') + '\n';

            calculationHistory.forEach(record => {
                const row = [
                    `"${record.productName.replace(/"/g, '""')}"`,
                    `"${record.competitorLink}"`,
                    record.sellingPrice || 'N/A',
                    record.purchaseCost,
                    record.headHaulCostCny || 'N/A',
                    record.fbaFeeCny || 'N/A',
                    record.netProfitCny || record.netProfitUsd || 'N/A',
                    record.profitMargin
                ];
                csvContent += row.join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "amazon_profit_history.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // æ¥æ”¶Chromeæ‰©å±•æ•°æ®
        function receiveExtensionData() {
            // æ£€æŸ¥localStorageä¸­æ˜¯å¦æœ‰æ‰©å±•æ•°æ®
            const extensionData = localStorage.getItem('amazonProductData');
            if (extensionData) {
                try {
                    const data = JSON.parse(extensionData);
                    fillFormWithExtensionData(data);
                    
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    const statusEl = document.getElementById('fetch-status');
                    if (statusEl) {
                        statusEl.textContent = 'å·²ä»Chromeæ‰©å±•æ¥æ”¶äº§å“ä¿¡æ¯ï¼';
                        statusEl.style.color = '#28a745';
                    }
                    
                    // æ¸…é™¤æ•°æ®é¿å…é‡å¤ä½¿ç”¨
                    localStorage.removeItem('amazonProductData');
                } catch (error) {
                    console.error('è§£ææ‰©å±•æ•°æ®å¤±è´¥:', error);
                }
            }
        }

        // ç”¨æ‰©å±•æ•°æ®å¡«å……è¡¨å•
        function fillFormWithExtensionData(data) {
            console.log('æ¥æ”¶åˆ°æ‰©å±•æ•°æ®:', data);
            
            // å¡«å……äº§å“åç§°
            if (data.title) {
                document.getElementById('productName').value = data.title;
            }
            
            // å¡«å……é‡é‡
            if (data.weightKg && data.weightKg > 0) {
                document.getElementById('prodWeight').value = data.weightKg.toFixed(3);
            }
            
            // å¡«å……å°ºå¯¸
            if (data.length && data.length > 0) {
                document.getElementById('prodLength').value = data.length.toFixed(2);
            }
            if (data.width && data.width > 0) {
                document.getElementById('prodWidth').value = data.width.toFixed(2);
            }
            if (data.height && data.height > 0) {
                document.getElementById('prodHeight').value = data.height.toFixed(2);
            }
            
            // å¡«å……é“¾æ¥
            if (data.url) {
                document.getElementById('competitorLink').value = data.url;
            }
            
            // éšè—æ‰‹åŠ¨è¾“å…¥æç¤º
            const helpDiv = document.getElementById('manual-help');
            if (helpDiv) {
                helpDiv.style.display = 'none';
            }
        }

        // ç›‘å¬æ¥è‡ªæ‰©å±•çš„å®æ—¶æ¶ˆæ¯
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'AMAZON_PRODUCT_DATA') {
                fillFormWithExtensionData(event.data.data);
                
                const statusEl = document.getElementById('fetch-status');
                if (statusEl) {
                    statusEl.textContent = 'å·²æ¥æ”¶Chromeæ‰©å±•æ•°æ®ï¼';
                    statusEl.style.color = '#28a745';
                }
            }
        });

        // ç›‘å¬localStorageå˜åŒ–
        window.addEventListener('storage', function(e) {
            if (e.key === 'amazonProductData' && e.newValue) {
                try {
                    const data = JSON.parse(e.newValue);
                    fillFormWithExtensionData(data);
                } catch (error) {
                    console.error('è§£æå­˜å‚¨æ•°æ®å¤±è´¥:', error);
                }
            }
        });

        // Modal functions
        function openModal() {
            document.getElementById("feedbackModal").style.display = "flex";
        }
        
        function closeModal() {
            document.getElementById("feedbackModal").style.display = "none";
        }

        function openDonate() {
            document.getElementById("donateModal").style.display = "flex";
        }
        
        function closeDonate() {
            document.getElementById("donateModal").style.display = "none";
        }

        // Load presets and history on page startup
        document.addEventListener('DOMContentLoaded', () => {
            loadPresetCosts();
            loadHistory();
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ‰©å±•æ•°æ®
            receiveExtensionData();
            
            // Add event listeners to save presets on change
            document.getElementById('exchangeRate').addEventListener('input', savePresetCosts);
            document.getElementById('headHaulRate').addEventListener('input', savePresetCosts);
        });

    </script>

</body>
</html>
